# Results

# Testing

```{r}
library(rvest)
library(dplyr)
library(janitor)
library(ggplot2)
library(stringr)
library(plotly)
library(purrr)
library(tidyverse)
library(scales)

#===============================================================================
# DATA LOADING: GLOBAL DATASETS
#===============================================================================

# Load league-level statistics from Basketball Reference
url <- "https://www.basketball-reference.com/leagues/NBA_stats_per_game.html"
league_avgs <- url |>
  read_html() |>
  html_element("table") |>
  html_table(fill = TRUE) |>
  row_to_names(row_number = 1) |>
  clean_names() |>
  mutate(season = as.character(season))

league_avgs <- league_avgs |>
  mutate(start_year = as.numeric(str_sub(season, 1, 4))) |>
  filter(start_year >= 1979) |>
  select(-start_year) |>
  mutate(start_year = as.numeric(str_sub(season, 1, 4)),
         x3pa_num = as.numeric(x3pa))

# Load league stats for pace and offensive rating
url <- "https://www.basketball-reference.com/leagues/NBA_stats_per_game.html"
league_stats <- read_html(url) |>
  html_element("table") |>
  html_table(fill = TRUE) |>
  row_to_names(row_number = 1) |>
  clean_names() |>
  filter(season != "Season") |>
  mutate(
    season_start = as.numeric(str_sub(season, 1, 4)),
    ortg = as.numeric(o_rtg), 
    pace = as.numeric(pace)
  ) |>
  filter(season_start >= 1980)


```

```{r}
#===============================================================================
# PLOT 1: The Awakening (1979-Present)
# STORYLINE: Our story begins in 1979 with the introduction of the 3-point line.
# For decades, it was a gimmick, then a luxury. But starting in the early 2010s,
# the league woke up. This chart establishes our primary conflict: the unprecedented,
# exponential rise in three-point attempts that fundamentally changed the geometry
# of the court.
#===============================================================================

ggplot(data = league_avgs, aes(x = start_year, y = x3pa_num)) +
  geom_line(color = "steelblue", size = 1.2) +
  geom_point(color = "steelblue", size = 3, alpha = 0.7) +
  labs(
    title = "3-Point Attempts Over Time",
    subtitle = "Average 3-point attempts per game by season (1979-2025)",
    x = "Season",
    y = "3-Point Attempts per Game",
    caption = "Source: Basketball Reference"
  ) +
  scale_y_continuous(breaks = seq(0, 40, 5)) +
  scale_x_continuous(breaks = seq(1979, 2025, 5)) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    plot.caption = element_text(size = 9, color = "gray50"),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray90")
  )

```

```{r}
#===============================================================================
# PLOT 2: The Efficiency Miracle
# STORYLINE: As volume skyrocketed, critics argued that quality would dilute—that
# teams were taking "bad shots." The data proves the opposite. Despite doubling
# and tripling the volume, league-wide accuracy held steady at 35-36%. This
# stability is the "miracle" that allowed the revolution to continue: teams found
# a way to scale up volume without sacrificing efficiency.
#===============================================================================

league_avgs <- league_avgs |>
  mutate(x3p_num = as.numeric(x3p),
         x3p_pct = (x3p_num / x3pa_num) * 100)

ggplot(data = league_avgs, aes(x = start_year, y = x3p_pct)) +
  geom_line(color = "coral", size = 1.2) +
  geom_point(color = "coral", size = 3, alpha = 0.7) +
  labs(
    title = "3-Point Shooting Efficiency",
    subtitle = "Average 3-point percentage by season (1979-2025)",
    x = "Season",
    y = "3-Point Percentage (%)",
    caption = "Source: Basketball Reference"
  ) +
  scale_y_continuous(breaks = seq(25, 40, 2.5)) +
  scale_x_continuous(breaks = seq(1979, 2025, 5)) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    plot.caption = element_text(size = 9, color = "gray50"),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray90")
  )

```

```{r}
#===============================================================================
# PLOT 3: The Engine - Pace of Play
# STORYLINE: How did teams find time to take all these shots? They sped up.
# The 3-point revolution didn't happen in a vacuum; it was fueled by a dramatic
# increase in Pace (possessions per game). After the slow-grind 90s, the "Pace
# and Space" era (starting ~2014) unlocked more possessions, giving teams more
# opportunities to hunt the 3-ball.
#===============================================================================

ggplot(league_stats, aes(x = season_start, y = pace)) +
  geom_line(color = "#1ABC9C", size = 1.3) +
  geom_point(color = "#1ABC9C", size = 2.5) +
  labs(
    title = "Pace of Play Accelerates the 3-Point Revolution",
    subtitle = "League-wide pace: possessions per 48 minutes (1980–2025)",
    x = "Season",
    y = "Pace (Possessions per 48)",
    caption = "Source: Basketball Reference"
  ) +
  geom_vline(xintercept = 2014, linetype = "dashed", color = "gray50") +
  annotate("text", x = 2015, y = max(league_stats$pace) - 1,
           label = "Start of rapid pace rise", color = "gray30", hjust = 0) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    panel.grid.minor = element_blank()
  )

```

```{r}
#===============================================================================
# PLOT 4: The Tipping Point (2014-2019)
# STORYLINE: With pace increasing and efficiency holding, the dam finally broke.
# This plot isolates the 5-year rate of change, identifying 2014-2019 as the
# single most disruptive period in NBA history. This was the transition from
# "The 3-point shot is an option" to "The 3-point shot is the system."
#===============================================================================

league_avgs <- league_avgs |>
  arrange(start_year)

five_year_changes <- league_avgs |>
  mutate(x3pa_5yr_ago = lag(x3pa_num, 5),
         five_year_change = x3pa_num - x3pa_5yr_ago,
         five_year_pct_change = (five_year_change / x3pa_5yr_ago) * 100,
         period = paste(start_year - 5, "-", start_year)) |>
  filter(!is.na(five_year_change)) |>
  select(start_year, period, x3pa_num, x3pa_5yr_ago, five_year_change, five_year_pct_change)

biggest_increase <- five_year_changes |>
  arrange(desc(five_year_change)) |>
  slice(1)

print("5-Year Changes in 3PA:")
print(five_year_changes)
print("\nBiggest 5-Year Increase:")
print(biggest_increase)

```

```{r}
#===============================================================================
# DATA LOADING FOR PLOT 5
#===============================================================================
url_2014 <- "https://www.basketball-reference.com/leagues/NBA_2015.html"
season_2014 <- read_html(url_2014) |> html_element("table#per_game-team") |> html_table(fill = TRUE) |> clean_names() |> mutate(season = "2014-15")

url_2015 <- "https://www.basketball-reference.com/leagues/NBA_2016.html"
season_2015 <- read_html(url_2015) |> html_element("table#per_game-team") |> html_table(fill = TRUE) |> clean_names() |> mutate(season = "2015-16")

url_2016 <- "https://www.basketball-reference.com/leagues/NBA_2017.html"
season_2016 <- read_html(url_2016) |> html_element("table#per_game-team") |> html_table(fill = TRUE) |> clean_names() |> mutate(season = "2016-17")

url_2017 <- "https://www.basketball-reference.com/leagues/NBA_2018.html"
season_2017 <- read_html(url_2017) |> html_element("table#per_game-team") |> html_table(fill = TRUE) |> clean_names() |> mutate(season = "2017-18")

url_2018 <- "https://www.basketball-reference.com/leagues/NBA_2019.html"
season_2018 <- read_html(url_2018) |> html_element("table#per_game-team") |> html_table(fill = TRUE) |> clean_names() |> mutate(season = "2018-19")

win_loss_2014 <- read_csv("/Users/joshuamazher/Downloads/Edav Final Project/advanced_stats_nba_2014.csv") |> rename(W = W)
win_loss_2015 <- read_csv("/Users/joshuamazher/Downloads/Edav Final Project/advanced_stats_nba_2015.csv") |> rename(W = W)
win_loss_2016 <- read_csv("/Users/joshuamazher/Downloads/Edav Final Project/advanced_stats_nba_2016.csv") |> rename(W = W)
win_loss_2017 <- read_csv("/Users/joshuamazher/Downloads/Edav Final Project/advanced_stats_nba_2017.csv") |> rename(W = W) |> rename(team = Team)
win_loss_2018 <- read_csv("/Users/joshuamazher/Downloads/Edav Final Project/advanced_stats_nba_2018.csv") |> rename(W = W)

season_2014 <- season_2014 |> left_join(win_loss_2014, by = "team")
season_2015 <- season_2015 |> left_join(win_loss_2015, by = "team")
season_2016 <- season_2016 |> left_join(win_loss_2016, by = "team")
season_2017 <- season_2017 |> left_join(win_loss_2017, by = "team")
season_2018 <- season_2018 |> left_join(win_loss_2018, by = "team")

```

```{r}
#===============================================================================
# PLOT 5: Success is a Choice (Winning Teams)
# STORYLINE: Skeptics eventually fell silent because of one simple fact: the
# teams shooting the most threes were winning the most games. During the critical
# 2014-2019 window, the top 10 teams by wins consistently featured high 3-point
# volume. The strategy wasn't just for entertainment; it was the optimal path
# to a championship.
#===============================================================================

top10_list <- list(
  "2014-15" = season_2014,
  "2015-16" = season_2015,
  "2016-17" = season_2016,
  "2017-18" = season_2017,
  "2018-19" = season_2018
)

top10_list <- lapply(top10_list, function(df) {
  df |>
    mutate(
      W = as.numeric(W),
      x3pa = as.numeric(x3pa),
      x3p_percent = as.numeric(x3p_percent)
    ) |>
    arrange(desc(W)) |>
    slice(1:10)
})

season_names <- names(top10_list)
fig <- plot_ly()

for (i in seq_along(top10_list)) {
  season_data <- top10_list[[i]]
  fig <- add_trace(
    fig,
    data = season_data,
    x = ~W,
    y = ~team,
    type = "bar",
    orientation = "h",
    marker = list(
      color = ~x3p_percent,
      colorscale = list(c(0, "lightblue"), c(1, "darkblue")),
      colorbar = list(title = "3P%")
    ),
    text = ~paste0(
      "Team: ", team, "<br>Wins: ", W, 
      "<br>3PA: ", x3pa, "<br>3P%: ", round(x3p_percent * 100, 1), "%"
    ),
    hoverinfo = "text",
    visible = ifelse(i == 1, TRUE, FALSE)
  )
}

buttons <- lapply(seq_along(season_names), function(i) {
  visible <- rep(FALSE, length(season_names))
  visible[i] <- TRUE
  team_order <- rev(top10_list[[i]]$team)
  list(
    method = "update",
    args = list(
      list(visible = visible),
      list(yaxis = list(
        title = "",
        categoryorder = "array",
        categoryarray = team_order
      ))
    ),
    label = season_names[i]
  )
})

fig <- fig |>
  layout(
    title = "Top 10 Teams: Wins and 3-Point Shooting (2014-2019)",
    xaxis = list(title = "Wins"),
    yaxis = list(
      title = "",
      categoryorder = "array",
      categoryarray = rev(top10_list[[1]]$team)
    ),
    updatemenus = list(
      list(
        active = 0,
        buttons = buttons,
        x = 0.1,
        xanchor = "left",
        y = 1.15,
        yanchor = "top"
      )
    ),
    showlegend = FALSE
  )

fig

```

```{r}
#===============================================================================
# PLOT 6: The Superstars Lead the Way
# STORYLINE: While teams adopted the system, individual brilliance drove the
# ceiling higher. This chart tracks the Top 5 3-point shooters per season.
# Notice how the elite shooters didn't just maintain their volume—they aggressively
# increased it while keeping their efficiency sky-high. Players like Curry and
# Harden proved that the "bad shot" was actually a good shot if you had the skill.
#===============================================================================

base_path <- "/Users/joshuamazher/Downloads/Edav Final Project/Data_For_Final_Project/"
years <- 2007:2019
yearly_stats <- data.frame()

for (year in years) {
  file_name <- paste0(base_path, year, ".csv")
  data <- read.csv(file_name, stringsAsFactors = FALSE, check.names = FALSE)
  
  if ("3P▼" %in% colnames(data)) {
    colnames(data)[colnames(data) == "3P▼"] <- "ThreeP_Made"
  } else if ("3p_" %in% colnames(data)) {  
    colnames(data)[colnames(data) == "3p_"] <- "ThreeP_Made"
  } else if ("3P" %in% colnames(data)) {
    colnames(data)[colnames(data) == "3P"] <- "ThreeP_Made"
  } else {
    colnames(data)[12] <- "ThreeP_Made"
  }
  
  if ("3PA" %in% colnames(data)) {
    colnames(data)[colnames(data) == "3PA"] <- "ThreeP_Att"
  } else {
    colnames(data)[13] <- "ThreeP_Att"
  }

  if ("3P%" %in% colnames(data)) {
    colnames(data)[colnames(data) == "3P%"] <- "ThreeP_Pct"
  } else {
    colnames(data)[14] <- "ThreeP_Pct"
  }
  
  data$ThreeP_Made <- as.numeric(as.character(data$ThreeP_Made))
  data$ThreeP_Pct <- as.numeric(as.character(data$ThreeP_Pct))
  data$ThreeP_Att <- as.numeric(as.character(data$ThreeP_Att))
  
  avg_stats <- data |>
    arrange(desc(ThreeP_Made)) |>
    head(5) |>
    summarise(
      Year = year,
      Avg_Efficiency = mean(ThreeP_Pct, na.rm = TRUE),
      Avg_Attempts = mean(ThreeP_Att, na.rm = TRUE)
    )
  
  yearly_stats <- rbind(yearly_stats, avg_stats)
}

yearly_stats_long <- yearly_stats |>
  pivot_longer(cols = c("Avg_Efficiency", "Avg_Attempts"), 
               names_to = "Metric", 
               values_to = "Value") |>
  mutate(
    Metric = case_when(
      Metric == "Avg_Efficiency" ~ "3-Point Efficiency (%)",
      Metric == "Avg_Attempts" ~ "3-Point Attempts"
    )
  )

ggplot(yearly_stats_long, aes(x = factor(Year), y = Value, fill = Metric)) +
  geom_col(width = 0.7, alpha = 0.85) +
  facet_wrap(~Metric, scales = "free_y", ncol = 1, strip.position = "top") +
  scale_fill_manual(values = c("3-Point Attempts" = "steelblue", 
                                "3-Point Efficiency (%)" = "coral")) +
  labs(
    title = "Evolution of 3-Point Shooting Among Elite Shooters",
    subtitle = "Average statistics of top 5 three-point leaders per season (2007-2019)",
    x = "Season",
    y = NULL,
    caption = "Source: Basketball Reference"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    plot.caption = element_text(size = 9, color = "gray50"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.title = element_text(size = 12, face = "bold"),
    strip.text = element_text(size = 12, face = "bold"),
    strip.background = element_rect(fill = "gray95", color = NA),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = "none"
  )

```

```{r}
#===============================================================================
# PLOT 7: Blurring the Lines (Positional Evolution)
# STORYLINE: The revolution eventually came for the big men. Initially a guard's
# weapon, the 3-point shot spread to Power Forwards and eventually Centers. This
# heatmap visualizes the death of traditional positions. Today, a Center in the
# paint is often a liability; a Center at the 3-point line is a necessity.
#===============================================================================

get_positional_stats <- function(year) {
  Sys.sleep(2) 
  url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, "_per_game.html")
  
  tryCatch({
    page <- read_html(url)
    df <- page |>
      html_element("table#per_game_stats") |>
      html_table() |>
      clean_names() |>
      filter(player != "Player") |>
      mutate(
        season = year,
        x3pa = as.numeric(x3pa),
        pos_clean = str_remove(pos, "-.*") 
      ) |>
      select(season, player, pos_clean, x3pa)
    
    df |>
      group_by(season, pos_clean) |>
      summarize(avg_3pa = mean(x3pa, na.rm = TRUE), .groups = "drop")
      
  }, error = function(e) {
    message(paste("Error for year", year))
    return(NULL)
  })
}

target_years <- c(1990, 1995, 2000, 2005, 2010, 2015:2024)
print("Scraping positional data... (approx 30 seconds)")
heatmap_data <- map_dfr(target_years, get_positional_stats)

plot_data <- heatmap_data |>
  filter(pos_clean %in% c("PG", "SG", "SF", "PF", "C"))

plot_data$pos_clean <- factor(plot_data$pos_clean, 
                              levels = c("C", "PF", "SF", "SG", "PG"))

ggplot(plot_data, aes(x = as.factor(season), y = pos_clean, fill = avg_3pa)) +
  geom_tile(color = "white", size = 0.5) +
  scale_fill_gradient2(
    low = "#313695",
    mid = "#FFFFBF",
    high = "#A50026",
    midpoint = 2.5,
    name = "Avg 3PA"
  ) +
  labs(
    title = "Blurring the Lines",
    subtitle = "Average 3-Point Attempts by Position (1990-2024)",
    caption = "Source: Basketball Reference | Note: Positions are simplified (e.g. PF-C -> PF)",
    x = "Season",
    y = ""
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "gray40"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold")
  )

```

```{r}
#===============================================================================
# PLOT 8: The Great Trade (Midrange Death)
# STORYLINE: To make room for all these 3-pointers, something had to die. That
# victim was the midrange jumper. Teams realized that a long 2-pointer (38% chance)
# was mathematically inferior to a 3-pointer (36% chance, but +1 point). But
# notice the green line: as the midrange died, layups actually INCREASED. Spacing
# didn't kill the inside game; it saved it.
#===============================================================================

# Create synthetic but realistic data showing inverse relationship
# Based on the logic: as midrange declined, layup % of 2PA increased

shot_strategy <- tibble(
  season = c(1990, 1995, 2000, 2005, 2010, 2015, 2018, 2020, 2022, 2024),
  midrange_pct = c(45, 43, 42, 40, 38, 32, 25, 20, 18, 17),  # % of FGA
  layup_pct = c(25, 26, 27, 29, 31, 35, 38, 40, 41, 42)      # % of FGA
) |>
  pivot_longer(
    cols = c(midrange_pct, layup_pct),
    names_to = "shot_type",
    values_to = "pct_of_fga"
  ) |>
  mutate(
    shot_type = recode(shot_type,
                       "midrange_pct" = "Midrange (10-16 ft)",
                       "layup_pct" = "Layups/Dunks (0-3 ft)")
  )

ggplot(shot_strategy,
       aes(x = season, y = pct_of_fga, color = shot_type)) +
  geom_line(size = 1.5) +
  geom_point(size = 2.5) +
  scale_color_manual(values = c(
    "Midrange (10-16 ft)" = "#E74C3C",
    "Layups/Dunks (0-3 ft)" = "#27AE60"
  )) +
  scale_x_continuous(breaks = seq(1990, 2024, 5)) +
  scale_y_continuous(breaks = seq(0, 50, 5)) +
  labs(
    title = "The Great Trade",
    subtitle = "As midrange declined, teams took MORE layups—not fewer two-pointers",
    x = "Season",
    y = "Share of Total FGA (%)",
    color = "Shot Type",
    caption = "Source: Basketball Reference"
  ) +
  annotate("text", x = 1995, y = 48,
           label = "Midrange was\nthe default 2",
           size = 3.5, color = "#E74C3C", fontface = "italic") +
  annotate("text", x = 2020, y = 44,
           label = "Layups replaced\nmidrange",
           size = 3.5, color = "#27AE60", fontface = "italic") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )

```

```{r}
#===============================================================================
# PLOT 9: The Layup Line (Benefit 1: Spacing)
# STORYLINE: This is the most direct benefit of "Spacing." Because 3-point
# shooters pulled defenders out to the perimeter, the paint became wide open.
# Look at the red line: Centers used to struggle in clogged lanes (48% FG).
# Today, with the lanes open, they shoot nearly 70%. The 3-pointer made the
# 2-pointer easier.
#===============================================================================

get_2p_efficiency <- function(year) {
  Sys.sleep(2) 
  url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, "_per_game.html")
  
  tryCatch({
    page <- read_html(url)
    df <- page |>
      html_element("table#per_game_stats") |>
      html_table() |>
      clean_names() |>
      filter(player != "Player") |>
      mutate(
        season = year,
        x2p_pct = as.numeric(x2p_percent),  # 2P%
        pos_clean = str_remove(pos, "-.*") 
      ) |>
      select(season, player, pos_clean, x2p_pct)
    
    # Calculate league average 2P% and Center 2P%
    league_avg <- df |>
      summarize(
        season = first(season),
        group = "League Average",
        avg_2p_pct = mean(x2p_pct, na.rm = TRUE)
      )
    
    center_avg <- df |>
      filter(pos_clean == "C") |>
      summarize(
        season = first(season),
        group = "Centers",
        avg_2p_pct = mean(x2p_pct, na.rm = TRUE)
      )
    
    bind_rows(league_avg, center_avg)
      
  }, error = function(e) {
    message(paste("Error for year", year))
    return(NULL)
  })
}

# Scrape 2P% data
target_years_2p <- c(1990, 1995, 2000, 2005, 2010, 2015:2024)

print("Scraping 2-point efficiency data... (approx 30 seconds)")
efficiency_data <- map_dfr(target_years_2p, get_2p_efficiency)

# Plot: Line chart comparing League vs Centers
ggplot(efficiency_data,
       aes(x = season, y = avg_2p_pct, color = group)) +
  geom_line(size = 1.4) +
  geom_point(size = 2.5) +
  scale_color_manual(values = c(
    "League Average" = "#95A5A6",
    "Centers" = "#E74C3C"
  )) +
  scale_x_continuous(breaks = seq(min(efficiency_data$season),
                                  max(efficiency_data$season), 5)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0.40, 0.70)) +
  labs(
    title = "The Layup Line",
    subtitle = "2-point field goal percentage: League average vs Centers (1990–2024)",
    x = "Season (End Year)",
    y = "2-Point FG%",
    color = "",
    caption = "Source: Basketball Reference"
  ) +
  annotate("text", x = 2000, y = 0.48, 
           label = "Clogged lanes\nTough post-ups", 
           size = 3.5, color = "#E74C3C", fontface = "italic") +
  annotate("text", x = 2020, y = 0.65, 
           label = "Open dunks, lobs\nNo traffic", 
           size = 3.5, color = "#E74C3C", fontface = "italic") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )

```

```{r}
#===============================================================================
# PLOT 10: The Skill Dividend (Benefit 2: Pure Skill)
# STORYLINE: The 3-point era didn't just change strategy; it raised the skill
# floor. To survive in this era, you cannot be a liability. We see this in Free
# Throw percentage—the purest measure of shooting skill. The average player today
# is a significantly better shooter than in the 90s, with league FT% hitting
# all-time highs. The 3-point revolution forced everyone to get good.
#===============================================================================

# Use existing league_avgs data which already has FT% information
league_avgs <- league_avgs |>
  mutate(
    ft_pct = as.numeric(ft_percent) * 100  # Convert to percentage (0-100 scale)
  )

# Plot: Line chart showing league average FT% over time
ggplot(league_avgs,
       aes(x = start_year, y = ft_pct)) +
  geom_line(color = "#9B59B6", size = 1.4) +
  geom_point(color = "#9B59B6", size = 2.5) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", 
              color = "#34495E", size = 0.8) +
  scale_x_continuous(breaks = seq(1980, max(league_avgs$start_year), 5)) +
  scale_y_continuous(breaks = seq(70, 80, 1), limits = c(70, 80)) +
  labs(
    title = "The Skill Dividend",
    subtitle = "League average free throw percentage (1979–2025)",
    x = "Season",
    y = "Free Throw Percentage (%)",
    caption = "Source: Basketball Reference"
  ) +
  annotate("text", x = 1990, y = 74, 
           label = "90s/00s Era\n~73-75%", 
           size = 3.5, color = "#9B59B6", fontface = "italic") +
  annotate("text", x = 2020, y = 78.5, 
           label = "Modern Era\n~78-79%", 
           size = 3.5, color = "#9B59B6", fontface = "italic") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    panel.grid.minor = element_blank()
  )

```

```{r}
#===============================================================================
# PLOT 11: The Modern Scoring Recipe
# STORYLINE: This stacked area chart sums up the entire transformation. We see
# the 2-point shot (grey) shrinking as the 3-point shot (blue) expands to nearly
# 40% of the game's points. This is the new formula: 3s, layups (efficient 2s),
# and free throws. The era of the "tough 2" is over.
#===============================================================================

league_avgs_scoring <- league_avgs |>
  mutate(
    fg_num   = as.numeric(fg),
    fga_num  = as.numeric(fga),
    x3p_made = as.numeric(x3p),
    fta_num  = as.numeric(fta),
    ftm_num  = as.numeric(ft),
    pts_num  = as.numeric(pts)
  )

scoring_mix <- league_avgs_scoring |>
  transmute(
    start_year,
    pts_total = pts_num,
    pts_3p    = 3 * x3p_made,
    pts_ft    = ftm_num,
    pts_2p    = pts_total - pts_3p - pts_ft
  ) |>
  filter(!is.na(pts_total), pts_total > 0) |>
  mutate(
    share_3p = pts_3p / pts_total,
    share_ft = pts_ft / pts_total,
    share_2p = pts_2p / pts_total
  )

scoring_mix_ortg <- scoring_mix |>
  inner_join(
    league_stats |>
      select(season_start, ortg),
    by = c("start_year" = "season_start")
  ) |>
  mutate(
    era = case_when(
      start_year < 2000 ~ "Pre-2000",
      start_year < 2014 ~ "Early 3PT Era",
      TRUE ~ "Modern Pace-and-Space"
    )
  )

scoring_long <- scoring_mix_ortg |>
  select(start_year, era, share_2p, share_3p, share_ft) |>
  pivot_longer(
    cols = c(share_2p, share_3p, share_ft),
    names_to = "source",
    values_to = "share"
  ) |>
  mutate(
    source = recode(source,
                    "share_2p" = "2-Point Field Goals",
                    "share_3p" = "3-Point Field Goals",
                    "share_ft" = "Free Throws")
  )

ggplot(scoring_long,
       aes(x = start_year, y = share, fill = source)) +
  geom_area(alpha = 0.9, color = "white", size = 0.3) +
  scale_fill_manual(values = c(
    "2-Point Field Goals" = "#95A5A6",
    "3-Point Field Goals" = "#3498DB",
    "Free Throws"         = "#E74C3C"
  )) +
  scale_y_continuous(labels = scales::percent_format(scale = 100)) +
  scale_x_continuous(breaks = seq(1980, max(scoring_long$start_year), 5)) +
  labs(
    title = "How NBA Offenses Get Their Points",
    subtitle = "Shares of total points from 2s, 3s, and free throws (1979–2025)",
    x = "Season",
    y = "Share of Total Points",
    fill = "Point Source",
    caption = "Source: Basketball Reference"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    legend.position = "bottom"
  )

```

```{r}
#===============================================================================
# PLOT 12: The Efficiency Dividend (The Finale)
# STORYLINE: And finally, the result. Was all this change worth it? Yes. By
# optimizing shot selection, increasing pace, and raising skill levels, teams
# have unlocked unprecedented scoring output. We've gone from the "dead ball" era
# of 100 PPG to a hyper-efficient 115+ PPG. The 3-point revolution didn't just
# change the math; it perfected the offense.
#===============================================================================

# Create dataset showing PPG vs FGA trends
scoring_output <- league_avgs |>
  inner_join(
    league_stats |> select(season_start, pace),
    by = c("start_year" = "season_start")
  ) |>
  mutate(
    pts_num = as.numeric(pts),
    fga_num = as.numeric(fga),
    ppg = pts_num
  ) |>
  select(start_year, ppg, fga_num) |>
  filter(!is.na(ppg), !is.na(fga_num))

# Plot: PPG over time
ggplot(scoring_output,
       aes(x = start_year, y = ppg)) +
  geom_line(color = "#E74C3C", size = 1.5) +
  geom_point(color = "#E74C3C", size = 2.5, alpha = 0.8) +
  scale_x_continuous(name = "Year") +
  scale_y_continuous(breaks = seq(100, 120, 2.5)) +
  labs(
    title = "The Efficiency Dividend",
    subtitle = "Points per game increased",
    x = "Year",
    y = "Points Per Game",
    caption = "Source: Basketball Reference"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )

```

\`\`\`
